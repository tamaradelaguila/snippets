clear
working = pwd;
cd '/home/tamara/Documents/MATLAB/VSDI/TORus';
user_settings
cd(working)

%----------------------------------------------------------------
% @SET: BASIC PARAMETERS
%----------------------------------------------------------------
ref_movie= '_18filt6' ;

savein = '/home/tamara/Documents/MATLAB/VSDI/TORus/plot/informes/03_figure_sketch/fast_plot' ;%@ SET
% load('/home/tamara/Documents/MATLAB/VSDI/TORus/plot/informes/03_figure_sketch/fast_condition_list.mat')
load('/home/tamara/Documents/MATLAB/VSDI/TORus/plot/informes/03_figure_sketch/groupplot_measures/groupplot_new.mat') % ATTENTION: select cases manually (there are repetitions)


%----------------------------------------------------------------
% @SET: fish + conditions
%----------------------------------------------------------------
nfish = 11;
cond_codes = [402];
saveraster = 1;


selroinames = {'dm4m_R2',  'dm2_R2' ,'dm1_R','dldm_R2', 'dldr_R'};%dm3
roikind = 'circle'; %


%----------------------------------------------------------------
% @SET: MEASURE (OR LOOP THROUGH ALL MEASURES)
%----------------------------------------------------------------
reject_on= 3;

setting.manual_reject = 1; %
setting.GSmethod_reject = 1;  %
setting.GSabsthres_reject = 1; %
setting.force_include = 0; %

%% LOAD / COMPUTE SETTINGS
%----------------------------------------------------------------
% LOAD DATA
%----------------------------------------------------------------
VSDI = TORus ('load', nfish);
VSDmov = TORus('loadmovie',nfish,ref_movie);

trange = [-300 1434]; %ms Range of analysis

%----------------------------------------------------------------
% COMPUTE REJECTION IDX FROM REJECT-OPTIONS
%----------------------------------------------------------------
rej = 'reject' ;
if reject_on > 1
    rej = [rej num2str(reject_on)];
end

rejectidx = [];

if setting.manual_reject
    rejectidx = [rejectidx  makeRow(VSDI.reject.manual)];
end

if setting.GSabsthres_reject
    rejectidx = [rejectidx  makeRow(VSDI.(rej).GSabs025)];
    
end

if setting.GSmethod_reject
    rejectidx = [rejectidx makeRow(VSDI.(rej).GSdeviat2sd)];
    
end

if setting.force_include
    rejectidx = setdiff(rejectidx, VSDI.reject.forcein);
    
end

rejectidx = sort(unique(rejectidx));


%----------------------------------------------------------------
% SELECT ROI
%----------------------------------------------------------------

switch roikind
    case 'circle'
        selroi =name2idx(selroinames, VSDI.roi.labels_circ);
        roilabels = VSDI.roi.labels_circ;
        masks =  VSDI.roi.circle.mask;
        
    case 'anat'
        selroi =name2idx(selroinames, VSDI.roi.labels);
        roilabels = VSDI.roi.labels;
        masks = VSDI.roi.manual_mask;
end

        %----------------------------------------------------------------
        % GET INDEXES OF TIMERANGE
        %----------------------------------------------------------------
        idxrange = dsearchn(makeCol(VSDI.timebase), makeCol(trange));
        idxrange = idxrange(1) : idxrange(end); % robust code in case we input both range or two-values
        
        timebase_adj = VSDI.timebase(idxrange);

%% ----------------------------------------------------------------
... BUILD RASTER
    %----------------------------------------------------------------
for condi = makeRow(cond_codes)
[sel_trials] = find(VSDI.condition(:,1)==condi);

if reject_on
    sel_trials = setdiff(sel_trials, rejectidx);
    disp('trials rejected')
end

n = numel(timebase_adj)-1;
roiraster = NaN(numel(sel_trials), n,  numel(selroi));

ii = 0; %counter for all rasters in 2D

for roii = makeRow(selroi)
    
    roimask = masks(:,:,roii);
    
    tri = 0;
    for triali = makeRow( sel_trials)
        tri = tri +1;
        ii = ii+1;
        %to plot single trial
        movie2plot = squeeze(VSDmov.data(:,:,idxrange,triali));
        meanF0 = squeeze(VSDmov.F0(:,:,triali));
        
        roiraster(tri,:,roii) =  roi_TSave_percF_roiwise(movie2plot,roimask, meanF0);
        rasters2D (ii,1:n) =  roi_TSave_percF_roiwise(movie2plot,roimask, meanF0);
    end % for triali
    ii = ii +1; 
    rasters2D (ii:ii+1,:) =  NaN(1,n);
    ii = ii +1; 
end % for roii

%% ----------------------------------------------------------------
... PLOT RASTER
%------------------------------------------------------------------

nroi = numel(selroi);
ploti = 0;
for roii = makeRow(selroi)
    ploti = ploti+1;
    h(ploti) = subplot(nroi,1,ploti);
    imagesc(roiraster(:,:,roii)); 
    axis tight
ylabel (roilabels{roii})
end 

end % for condi
